# Migration Plan: Replace `request` / `request-promise-native` with `undici`

Summary
- Objective: Remove deprecated and vulnerable `request` (and `request-promise-native`) usage by migrating HTTP calls to `undici` (Node's modern HTTP client / fetch API). This removes transitive vulnerabilities (form-data, qs, tough-cookie) caused by `request`.

Scope
- PoC: Update `src/jenkinsService.ts` (primary location of HTTP calls) to use `undici` (fetch) for `get`/`post` calls. Validate behavior and tests.
- Follow-up: Replace any remaining `request` usages and update code that relied on `request` features (form, cookie handling) accordingly.
- Remove `request` and `request-promise-native` from `package.json` once usages are replaced.

Why
- `request` is deprecated and has critical transitive vulnerabilities (form-data, qs, tough-cookie).
- `undici` provides modern, supported HTTP client behavior; using fetch-style calls reduces maintenance and security risk.

Plan / Steps
1. Create a branch `chore/replace-request-with-undici`.
2. Add `undici` as a dependency (`npm install undici --save`).
3. Implement a small fetch wrapper/util in `src/utils.ts` or `src/httpClient.ts` that handles headers and token/cancel semantics used by `jenkinsService`.
4. Replace `request` usages only in `src/jenkinsService.ts` and validate behavior:
   - Replace `request.get(url, { headers: this._headers })` with `await fetch(url, { method: 'GET', headers: this._headers })` semantics.
   - Replace `request.post({ url, form: { script: source }, headers })` with `fetch(url, { method: 'POST', body: new URLSearchParams({ script: source }), headers })` (set content-type appropriately).
   - For streaming or large uploads, use `undici`'s streaming APIs if necessary.
5. Run `npm run compile` and local smoke tests (manual scenario with a local Jenkins server or stubs) and `npm test` (if present).
6. Create a PR with the PoC changes, request review, include migration plan link.
7. After merge, run `npm audit` to verify transitive vulnerabilities are resolved.
8. Repeat for other modules if needed.

Testing
- Unit tests (add if missing) and manual verification against a Jenkins server for key flows: job listing, build output streaming, pipeline script fetch, POST actions.
- CI: run `npm run compile` and any test runner.

Rollback
- Revert the small PR if runtime behavior is broken; iterate on fixes in subsequent PRs.

Notes
- This PR will be split into small changes to keep the review surface small.
- Some transitive vulnerabilities may remain until `request` is fully removed; however, replacing `request` should remove the majority of critical issues.

PoC target file(s):
- `src/jenkinsService.ts` (primary)
- Potential helper: `src/httpClient.ts` or add into `src/utils.ts`

Assignee: @YangKangSung

---

(Generated by automation)